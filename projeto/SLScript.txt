CREATE OR ALTER VIEW VIEWHISTORICOPRODUTO(
    DATAINICIO,
    DATAFIM,
    DATAHORAINICIO,
    DATAHORAFINAL,
    TIPO,
    NOMETIPO,
    CODIGOCLIENTE,
    NOMECLIENTE,
    CODIGOPRODUTO,
    NOMEPRODUTO,
    CODIGOREGISTRO,
    OBSERVACOES,
    REFERENCIA,
    DEVOLVIDO,
    TIPOCONVIDADO)
AS
SELECT X.DATAINICIO, X.DATAFIM,
       X.DATAHORAINICIO, X.DATAHORAFINAL, X.TIPO,
       CASE X.TIPO
         WHEN 1 THEN 'AGENDA'
         WHEN 2 THEN 'ALUGUEL'
         WHEN 3 THEN 'ORDEM DE SERVICO'
       END AS NOMETIPO,

       X.CODIGOCLIENTE, C.NOME AS NOMECLIENTE,

       X.CODIGOPRODUTO, P.DESCRICAO AS NOMEPRODUTO,

       X.CODIGOREGISTRO, X.OBSERVACOES,

       P.REFERENCIA, X.DEVOLVIDO, X.TIPOCONVIDADO


FROM (

SELECT A.DATA AS DATAINICIO, A.DATAFIM,
       CAST(A.DATA + A.HORA AS TIMESTAMP) AS DATAHORAINICIO,
       CAST(A.DATAFIM + A.HORAFIM AS TIMESTAMP) AS DATAHORAFINAL,
       1 AS TIPO,
       A.IDPERFIL CODIGOCLIENTE,
       D.CODIGOPRODUTO,

   A.CODIGO AS CODIGOREGISTRO,

   A.descricao AS OBSERVACOES,

   0 DEVOLVIDO,

   TC.NOME AS TIPOCONVIDADO

FROM TABAGENDA A
INNER JOIN TABARARA AR ON (A.CODIGO = AR.CODIGOAGENDA)
INNER JOIN TABARARADETALHE D ON (AR.CODIGO = D.CODIGOARARA)
 LEFT JOIN tabacompanhantespedidoagenda PA ON PA.codigopedido = A.idpedidoagenda AND PA.codigoperfil = A.IDPERFIL
 LEFT JOIN tabtipoconvidado TC ON TC.codigo = PA.codigotipoconvidado

WHERE A.situacao = 3




UNION ALL


SELECT C.DATARESERVA AS DATAINICIO, C.DATARETORNO AS DATAFIM,

       (CAST(C.DATARESERVA + C.HORARESERVA AS TIMESTAMP)) -
       CASE
         WHEN PR.CODIGOPREFERENCIA IS NULL THEN
           COALESCE(C.DIASBLOQUEIOAUTOMATICO,0)
       ELSE COALESCE((Select first 1 VALOR_INTEIRO
                        from TABCONFIGURACOES
                       where UPPER(FORM_NAME) = 'FRMCONTRATO'
                       and UPPER(CONFIG_NAME) = 'DIASBLOQUEIOAUTOMATICO_ACESSORIOS'),0)
       END AS DATAHORAINICIO,

       (CAST(C.DATARETORNO + C.HORARETORNO AS TIMESTAMP)) +
       CASE
         WHEN PR.CODIGOPREFERENCIA IS NULL THEN
           COALESCE(C.DIASBLOQUEIOAUTOMATICOAPOS,0)
       ELSE COALESCE((Select first 1 VALOR_INTEIRO
                        from TABCONFIGURACOES
                       where UPPER(FORM_NAME) = 'FRMCONTRATO'
                       and UPPER(CONFIG_NAME) = 'DIASBLOQUEIOAUTOMATICO_ACESSORIOS'),0)
       END AS DATAHORAFINAL,
       2 AS TIPO,
       C.CODIGOCLIENTE,
       D.CODIGOPRODUTO,

       C.CODIGO AS CODIGOREGISTRO,

       C.OBSERVACOES,

       COALESCE(D.DEVOLVIDO,0) AS DEVOLVIDO,

       TC.NOME AS TIPOCONVIDADO


 FROM TABCONTRATO C
INNER JOIN TABCONTRATODETALHE D ON (C.CODIGO = D.CODIGO)
 LEFT JOIN TABSITUACAOPRODUTO S ON (C.CODIGOSITUACAO = S.CODIGO)
 LEFT JOIN TABPREFERENCIASPRODUTO PR ON (D.CODIGOPRODUTO = PR.CODIGOPRODUTO AND PR.TIPO = 2)
 LEFT JOIN TABAGENDA A ON A.codigo = C.CODIGOAGENDA
 LEFT JOIN tabacompanhantespedidoagenda PA ON PA.codigopedido = A.idpedidoagenda AND PA.codigoperfil = C.CODIGOCLIENTE
 LEFT JOIN tabtipoconvidado TC ON TC.codigo = PA.codigotipoconvidado

 WHERE c.codigosituacao <> 4

UNION ALL


SELECT O.DATAINICIO, O.DATAFIM,
       CAST(O.DATAINICIO + O.HORAINICIO AS TIMESTAMP) AS DATAHORAINICIO,
       CAST(COALESCE(D.DATAFIM,O.DATAFIM) + COALESCE(D.HORAFIM,O.HORAFIM) AS TIMESTAMP) DATAHORAFINAL,
       3 TIPO,
       O.CODIGOPERFIL AS CODIGOCLIENTE,
       D.CODIGOPRODUTO,

       O.CODIGO AS CODIGOREGISTRO,

       O.OBSERVACOES,

       CASE
         WHEN (D.DEVOLVIDO = 1) OR (D.DATAFIM IS NOT NULL) THEN 1
       ELSE
         0
       END DEVOLVIDO,

       NULL as TIPOCONVIDADO


  FROM TABOS O
 INNER JOIN TABOSDETALHE D ON (O.CODIGO = D.CODIGOOS)


) X

LEFT JOIN TABPERFIL C ON (X.CODIGOCLIENTE = C.CODIGO)
LEFT JOIN TABPRODUTOS P ON (X.CODIGOPRODUTO = P.CODIGO)

ORDER BY 9, 3
;;

create or alter procedure PROC_RATEIO_AC_D_CONTRATO (
    CODIGO integer,
    ID integer)
returns (
    RESULT float)
as
declare variable VALORTOTAL float;
declare variable DESCONTO float;
declare variable VALOR float;
declare variable PERC_DESC float;
begin
  SELECT c.valordesconto from tabcontrato C where c.codigo = :codigo into desconto;
  select sum(d.valor) from tabcontratodetalhe d where d.codigo = :codigo into valortotal;
  select d.valor from tabcontratodetalhe d where d.codigo = :codigo and d.id = :id into valor;
  perc_desc = (desconto * 100) / valortotal;
  result = valor * (perc_desc / 100);
  suspend;
end;;


ALTER TABLE TABPERFIL ADD CREDITO NUMERICO2D;;

ALTER TABLE TABTIPODOCUMENTO ADD FIN_ABATIMENTOCREDITO INTEIRO;;